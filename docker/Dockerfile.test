# Test environment for PinGuard
FROM rust:1.89.0

# Install build and test dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    libsqlite3-dev \
    curl \
    wget \
    git \
    && rm -rf /var/lib/apt/lists/*

# Set the working directory
WORKDIR /app

# Copy the entire project
COPY pinGuard/ ./

# Install additional test tools
RUN cargo install cargo-audit cargo-tarpaulin cargo-deny

# Create test script
RUN echo '#!/bin/bash\n\
set -e\n\
echo "Running cargo check..."\n\
cargo check\n\
echo "Running cargo test..."\n\
cargo test\n\
echo "Running cargo audit..."\n\
cargo audit\n\
echo "Running cargo clippy..."\n\
cargo clippy -- -D warnings\n\
echo "Running cargo fmt check..."\n\
cargo fmt --all -- --check\n\
echo "All tests passed!"\n\
' > /app/run_tests.sh && chmod +x /app/run_tests.sh

# Set environment for testing
ENV RUST_BACKTRACE=1
ENV RUST_LOG=debug

# Default command runs all tests
CMD ["/app/run_tests.sh"]
